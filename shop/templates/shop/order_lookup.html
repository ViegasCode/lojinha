<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Buscar meu pedido</title>
  <style>
    body{font-family:system-ui;margin:16px}
    form{margin:12px 0;padding:12px;border:1px solid #e5e7eb;border-radius:12px;max-width:460px}
    label{display:block;margin:8px 0}
    button{padding:8px 12px;border:1px solid #111;border-radius:8px;background:#111;color:#fff}
    .muted{color:#6b7280}
    .success{color:#065f46}
    .error{color:#991b1b}
    .hidden{display:none}
  </style>
</head>
<body>
  <a href="/">← Voltar</a>
  <h1>Buscar meu pedido</h1>
  <p class="muted">Informe o e-mail usado na compra e o código curto do pedido para receber um código de verificação (OTP).</p>

  <!-- evita validação nativa do browser; validamos via JS -->
  <form id="lookupForm" novalidate>
    {% csrf_token %}
    <label>Email:
      <input required type="email" name="email" placeholder="seu@email.com" />
    </label>
    <label>Código do pedido (short_code):
      <input required name="short_code" placeholder="ex.: A1B2C3D4" />
    </label>
    <button type="submit">Enviar código</button>
    <div id="lookupMsg" class="muted"></div>
  </form>

  <form id="otpForm" class="hidden" novalidate>
    {% csrf_token %}
    <label>Digite o código recebido (OTP):
      <input required name="otp" maxlength="6" inputmode="numeric" autocomplete="one-time-code" placeholder="123456" />
    </label>
    <button type="submit">Ver meu pedido</button>
    <div id="otpMsg" class="muted"></div>
  </form>

  <script>
    function getCookie(name){
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if(parts.length === 2) return parts.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken') || '';

    const lookupForm = document.getElementById('lookupForm');
    const otpForm = document.getElementById('otpForm');
    const lookupMsg = document.getElementById('lookupMsg');
    const otpMsg = document.getElementById('otpMsg');

    let context = { email: '', short_code: '' };

    lookupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(lookupForm);
      context.email = (fd.get('email') || '').trim();
      context.short_code = (fd.get('short_code') || '').trim();
      if(!context.email){
        lookupMsg.textContent = 'Informe um e-mail válido.';
        lookupMsg.className = 'error';
        return;
      }
      lookupMsg.textContent = 'Enviando código...';
      lookupMsg.className = 'muted';
      try{
        const r = await fetch('/api/orders/lookup',{
          method:'POST',
          headers:{'Content-Type':'application/json','X-CSRFToken': csrftoken},
          body: JSON.stringify(context)
        });
        const txt = await r.text();
        if(!r.ok){
          lookupMsg.textContent = 'Erro: ' + txt.slice(0,200);
          lookupMsg.className = 'error';
          return;
        }
        lookupMsg.textContent = 'Código enviado! Confira seu e-mail (ou console, se estiver usando EMAIL_BACKEND=console).';
        lookupMsg.className = 'success';
        otpForm.classList.remove('hidden');
        otpForm.querySelector('input[name="otp"]').focus();
      }catch(err){
        lookupMsg.textContent = 'Erro inesperado: '+err;
        lookupMsg.className = 'error';
      }
    });

    otpForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(otpForm);
      let otp = (fd.get('otp') || '');
      otp = otp.replace(/\D/g,''); // só dígitos
      if(otp.length !== 6){
        otpMsg.textContent = 'Digite os 6 dígitos do código.';
        otpMsg.className = 'error';
        return;
      }
      const payload = { ...context, otp };
      otpMsg.textContent = 'Verificando...';
      otpMsg.className = 'muted';
      try{
        const r = await fetch('/api/orders/verify-otp', {
          method:'POST',
          headers:{'Content-Type':'application/json','X-CSRFToken': csrftoken},
          body: JSON.stringify(payload)
        });
        const txt = await r.text();
        if(!r.ok){
          otpMsg.textContent = 'Erro: ' + txt.slice(0,200);
          otpMsg.className = 'error';
          return;
        }
        const data = JSON.parse(txt);
        if(data.public_url){
          window.location.href = data.public_url;
        } else {
          otpMsg.textContent = 'Resposta sem link do pedido.';
          otpMsg.className = 'error';
        }
      }catch(err){
        otpMsg.textContent = 'Erro inesperado: '+err;
        otpMsg.className = 'error';
      }
    });
  </script>
</body>
</html>
