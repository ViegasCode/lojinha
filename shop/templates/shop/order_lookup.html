<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Buscar meu pedido</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="/static/css/order_lookup.css">
</head>
<body>

  <main class="lookup-container">
    <a href="/" class="back-link">← Voltar para a loja</a>
    <h1>Buscar Meu Pedido</h1>
    <p class="intro-text">Informe o e-mail usado na compra e o código do pedido para receber um código de verificação.</p>

    <form id="lookupForm" novalidate>
      {% csrf_token %}
      <label for="email-input">Email:</label>
      <input id="email-input" required type="email" name="email" placeholder="seu@email.com" />
      
      <label for="short-code-input" style="margin-top: 16px;">Código do pedido:</label>
      <input id="short-code-input" required type="text" name="short_code" placeholder="Ex.: A1B2C3D4" />
      
      <button type="submit">Enviar código de acesso</button>
      <div id="lookupMsg" class="message muted"></div>
    </form>

    <form id="otpForm" class="hidden" novalidate>
      {% csrf_token %}
      <label for="otp-input">Digite o código de 6 dígitos recebido:</label>
      <input id="otp-input" required name="otp" maxlength="6" inputmode="numeric" autocomplete="one-time-code" placeholder="123456" />
      
      <button type="submit">Ver meu pedido</button>
      <div id="otpMsg" class="message muted"></div>
    </form>
  </main>

  <script>
    function getCookie(name){
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if(parts.length === 2) return parts.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken') || '';

    const lookupForm = document.getElementById('lookupForm');
    const otpForm = document.getElementById('otpForm');
    const lookupMsg = document.getElementById('lookupMsg');
    const otpMsg = document.getElementById('otpMsg');

    let context = { email: '', short_code: '' };

    lookupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(lookupForm);
      context.email = (fd.get('email') || '').trim();
      context.short_code = (fd.get('short_code') || '').trim();
      if(!context.email){
        lookupMsg.textContent = 'Informe um e-mail válido.';
        lookupMsg.className = 'message error';
        return;
      }
      lookupMsg.textContent = 'Enviando código...';
      lookupMsg.className = 'message muted';
      try{
        const r = await fetch('/api/orders/lookup',{
          method:'POST',
          headers:{'Content-Type':'application/json','X-CSRFToken': csrftoken},
          body: JSON.stringify(context)
        });
        const txt = await r.text();
        if(!r.ok){
          lookupMsg.textContent = 'Erro: ' + txt.slice(0,200);
          lookupMsg.className = 'message error';
          return;
        }
        lookupMsg.textContent = 'Código enviado! Confira seu e-mail.';
        lookupMsg.className = 'message success';
        otpForm.classList.remove('hidden');
        otpForm.querySelector('input[name="otp"]').focus();
      }catch(err){
        lookupMsg.textContent = 'Erro inesperado: '+err;
        lookupMsg.className = 'message error';
      }
    });

    otpForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(otpForm);
      let otp = (fd.get('otp') || '');
      otp = otp.replace(/\D/g,'');
      if(otp.length !== 6){
        otpMsg.textContent = 'Digite os 6 dígitos do código.';
        otpMsg.className = 'message error';
        return;
      }
      const payload = { ...context, otp };
      otpMsg.textContent = 'Verificando...';
      otpMsg.className = 'message muted';
      try{
        const r = await fetch('/api/orders/verify-otp', {
          method:'POST',
          headers:{'Content-Type':'application/json','X-CSRFToken': csrftoken},
          body: JSON.stringify(payload)
        });
        const txt = await r.text();
        if(!r.ok){
          otpMsg.textContent = 'Erro: ' + txt.slice(0,200);
          otpMsg.className = 'message error';
          return;
        }
        const data = JSON.parse(txt);
        if(data.public_url){
          window.location.href = data.public_url;
        } else {
          otpMsg.textContent = 'Resposta sem link do pedido.';
          otpMsg.className = 'message error';
        }
      }catch(err){
        otpMsg.textContent = 'Erro inesperado: '+err;
        otpMsg.className = 'message error';
      }
    });
  </script>
</body>
</html>