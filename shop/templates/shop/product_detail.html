<!doctype html>
<html lang="pt-br">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ product.title }}</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/product_detail.css' %}" />
</head>
<body>
    {% load pricing %}
    <div class="container">
        <a href="/">← Voltar</a>
        
        <div class="product-layout">
            {% if product.image_url %}
                <div class="product-image">
                    <img src="{{ product.image_url }}" alt="{{ product.title }}" />
                </div>
            {% endif %}
            <div class="product-details">
                <p class="price">{{ product.price_cents|money }}</p>
                
                <h1>{{ product.title }}</h1>

                {% if product.stock == 0 %}
                    <span class="badge out">Sem estoque</span>
                {% elif product.stock <= 3 %}
                    <span class="badge warn">Acaba logo</span>
                {% endif %}
                
                {% installment_plans product.price_cents as plans %}
                {% if plans %}
                    <div class="installments">
                        <label for="installment-options">Parcelamento sem juros:</label>
                        <select name="installments" id="installment-options">
                            {% for pl in plans %}
                                <option value="{{ pl.n }}">
                                    {{ pl.n }}x de {{ pl.per_cents|money }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                {% endif %}
    
                <form id="buyForm">
                    {% csrf_token %}
                    <input type="hidden" name="product_id" value="{{ product.id }}" />
                    <div class="form-group">
                        <label for="id_qty">Quantidade:</label>
                        <input type="number" id="id_qty" name="qty" value="1" min="1" max="{{ product.stock }}">
                    </div>
                    <div class="form-group">
                        <label for="id_email">Email (para receber link mágico):</label>
                        <input required type="email" id="id_email" name="email">
                    </div>
                    <div class="form-group">
                        <label for="id_phone">WhatsApp (opcional):</label>
                        <input name="phone" id="id_phone" placeholder="+55...">
                    </div>
                    <div class="actions">
                        <button type="submit" {% if product.stock == 0 %}disabled{% endif %}>Comprar agora</button>
                        <button type="button" id="btn-add-cart">Adicionar ao carrinho</button>
                        <a href="/carrinho/" class="btn secondary">Ir ao carrinho</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
      function getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(';').shift();
      }
      const csrftoken = getCookie('csrftoken') || '';
      const form = document.getElementById('buyForm');
  
      form.addEventListener('submit', async (e) => {
          e.preventDefault();
          if ({% if product.stock == 0 %}true{% else %}false{% endif %}) {
              alert('Produto sem estoque.');
              return;
          }
          const fd = new FormData(form);
          const payload = Object.fromEntries(fd.entries());
          payload.qty = parseInt(payload.qty || '1', 10);
          try {
              const r = await fetch('/api/checkout', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                  body: JSON.stringify(payload)
              });
              if (!r.ok) {
                  const txt = await r.text();
                  alert('Erro no checkout: ' + txt.slice(0, 200));
                  return;
              }
              const data = await r.json();
              if (data.init_point) window.location.href = data.init_point;
              else alert('Falha ao criar checkout.');
          } catch (err) {
              alert('Erro inesperado: ' + err);
          }
      });
  
      document.getElementById('btn-add-cart').addEventListener('click', async () => {
          if ({% if product.stock == 0 %}true{% else %}false{% endif %}) {
              alert('Produto sem estoque.');
              return;
          }
          const qty = parseInt((new FormData(form)).get('qty') || '1', 10);
          const payload = { product_id: {{ product.id }}, qty: qty };
          try {
              const r = await fetch('/api/cart/add', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                  body: JSON.stringify(payload)
              });
              if (!r.ok) {
                  const txt = await r.text();
                  alert('Erro ao adicionar: ' + txt.slice(0, 200));
                  return;
              }
              window.location.href = '/carrinho/';
          } catch (err) {
              alert('Erro inesperado: ' + err);
          }
      });
    </script>
</body>
</html>